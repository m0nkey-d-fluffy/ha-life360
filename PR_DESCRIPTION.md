# Add Optional Device ID Configuration for Tile Device Names

## Summary

This PR adds an optional **Device ID** configuration field that enables proper device names for Tile Bluetooth trackers and Jiobit pet GPS devices. Without this configuration, devices will show generic names (e.g., "Tile 12345678") that users can manually rename in Home Assistant.

## Problem

When Tile or Jiobit devices are linked to a Life360 account, the integration creates device tracker entities. However, these entities were showing generic names based on their device IDs instead of the actual names configured in the Life360 app (e.g., "Keys", "Wallet", "Fluffy").

**Root Cause:**
Device names come from the Life360 `/v6/devices` metadata endpoint, which requires authentication using a valid Life360 device ID in the `x-device-id` header. Without this device ID, the endpoint returns HTTP 401 (Unauthorized), causing the integration to fall back to generic names.

## Investigation

During troubleshooting, we discovered:

1. **Device Registration Doesn't Work**: The `/v3/users/devices` POST endpoint accepts device registration requests but returns an empty list `[]` with HTTP 200, regardless of the payload sent. It does not return or create valid device IDs.

2. **Device IDs Are App-Generated**: Device IDs are generated by the Life360 mobile app (not the OS) and have the format:
   - Android: `androidXxYyZz1234AbCdEf5678Gh` (29 characters: "android" + 22-char alphanumeric)
   - iOS: Similar format starting with "ios"

3. **Life360 Validates Device IDs**: The Life360 API validates device IDs against their internal database and only accepts IDs from actual mobile app installations. Generated IDs are rejected.

4. **No API Returns Device IDs**: After analyzing mitmproxy flows from real Android devices, we confirmed that device IDs only appear in request headers (`x-device-id` and `ce-source`), never in API responses.

## Solution

Since device IDs cannot be obtained programmatically, this PR implements an **optional configuration field** where users can manually provide their device ID.

### Behavior

- **With Device ID configured**: Tile/Jiobit devices show their actual names from Life360
- **Without Device ID**: Devices show generic names that users can manually rename in Home Assistant
- All other functionality works normally regardless of device ID configuration

### User Experience

1. Users who don't configure a device ID will see a log message on first load:
   ```
   No device ID configured. Tile/Jiobit devices will show generic names.
   To see actual device names, configure your device ID in integration options.
   ```

2. Users can obtain their device ID by:
   - Using network monitoring tools (mitmproxy, Charles Proxy, HTTP Toolkit)
   - Capturing Life360 app traffic and looking for the `x-device-id` header
   - Following the detailed instructions in the updated documentation

## Changes

### Code Changes

**`custom_components/life360/const.py`**
- Added `CONF_DEVICE_ID = "device_id"` constant

**`custom_components/life360/helpers.py`**
- Added `device_id: str | None = None` field to `ConfigOptions` dataclass
- Updated `from_dict()` to handle optional `device_id` field

**`custom_components/life360/config_flow.py`**
- Added Device ID text input field to configuration options
- Field appears in the main options screen alongside GPS accuracy and driving settings
- Strips whitespace from user input
- Persists device ID in integration options

**`custom_components/life360/coordinator.py`**
- Simplified `_get_or_register_device_id()` method:
  - Removed automatic device ID generation logic (~105 lines removed)
  - Returns configured device ID if provided
  - Returns None with helpful log message if not configured
- No longer attempts device registration (which never worked)

### Documentation Updates

**`README.md`**
- Added "Device ID (Optional)" section to Configuration Options
- Explains when device ID is needed and how to obtain it
- Links to detailed documentation

**`docs/tiles-and-devices.md`**
- Added "Device Names" section explaining behavior with/without device ID
- Added "Configuring Device ID" section with:
  - What a device ID is
  - How to obtain it using network monitoring tools
  - Step-by-step Home Assistant configuration instructions
- Added "Devices Show Generic Names" troubleshooting section
- Updated "API Details" section documenting both location and metadata endpoints

**`docs/api_endpoints.md`**
- Updated `/v3/users/devices` description noting it returns empty list
- Updated `/v6/devices` description noting authentication requirements
- Added "Device ID Authentication" section explaining:
  - Device ID format and structure
  - Why automatic generation doesn't work
  - How to obtain device IDs from network traffic

### Test Updates

**`tests/test_init.py`**
- Added `device_id` parameter to `cfg_options()` helper function
- Defaults to `None` for backward compatibility
- All existing tests continue to pass without modifications

## Commit History

### Final Implementation (Current Solution)
- `7279f64` Update tests for device_id configuration option
- `a95d4e8` Update documentation for device_id configuration
- `7d97208` Add optional device_id configuration for Tile device names

### Investigation & Discovery
- `bcc51b2` Add detailed logging for device registration response
- `f8eb6fc` Generate Android-style device ID per installation
- `793f796` Use existing Android device ID for metadata endpoint
- `071f4ac` Test: Skip device registration to test metadata endpoint
- `71d3f4d` Handle empty list response from device registration API
- `b05e8ef` Fix device registration to use form-encoded data

### Initial Troubleshooting
- `1ecb6dc` Fix Tile device names showing as generic IDs
- `3831a41` Update API user agent for Life360 integration
- `acee93b` Modify device ID and payload for iOS registration
- `4e02ff0` Update device version and app version for API
- `fc34ac4` Change device profile to Google Pixel 6
- `57dc317` Refactor device registration to use Samsung Galaxy profile

The commit history shows the progression from attempting automatic device registration (which we discovered doesn't work) to the final solution of optional user configuration.

## Usage

### For Users With Tile/Jiobit Devices Who Want Actual Names

1. Capture your device ID from the Life360 app using network monitoring tools
2. Go to **Settings** → **Devices & Services** → **Life360** → **Configure**
3. Enter your device ID in the **Device ID** field
4. Click **Submit** and reload the integration
5. Tile/Jiobit devices will now show their actual names

### For Users Who Don't Configure Device ID

- Tile/Jiobit devices will show generic names like "Tile 12345678"
- Users can manually rename entities in Home Assistant
- All location tracking and other features work normally

## Backward Compatibility

✅ **Fully backward compatible**

- Device ID field is optional with default value `None`
- Existing installations continue to work without any changes
- No migration needed
- All existing tests pass without modifications

## Testing

- ✅ Configuration flow accepts and persists device ID
- ✅ Integration works without device ID configured (shows generic names)
- ✅ All existing unit tests pass
- ✅ Tested with real mitmproxy flows from Android device
- ✅ Confirmed device registration returns empty list (as documented)
- ✅ Verified metadata endpoint returns 401 without valid device ID

## Additional Notes

### Why Automatic Device Registration Doesn't Work

We attempted multiple approaches to automatically register devices:
- Different device profiles (Samsung, Google Pixel, iOS)
- Various payload formats (JSON, form-encoded)
- Different API versions
- Correct CloudEvents headers

All attempts resulted in:
- HTTP 200 response with empty list `[]`
- No device ID returned in response
- Metadata endpoint still returns 401 with generated IDs

**Conclusion**: Life360 validates device IDs server-side and only accepts IDs from actual mobile app installations. This cannot be bypassed programmatically.

### Future Enhancements

Potential future improvements (not in this PR):
- Provide more detailed instructions for extracting device IDs on different platforms
- Add validation for device ID format
- Consider implementing a device ID verification check
